<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hazuki â€” Shadow Portfolio</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Sans:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
</head>
<body>

    <header class="animate-in">
        <a href="index.html" class="site-title">Hazuki <span class="jp">ã‚·ãƒ£ãƒ‰ã‚¦ãƒ»ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</span></a>
        <nav>
            <a href="index.html" class="active">Portfolio</a>
            <a href="philosophy.html">Philosophy</a>
            <a href="trades.html">Trades</a>
            <a href="research.html">Research</a>
            <a href="about.html">About</a>
        </nav>
    </header>

    <hr class="divider">

    <!-- Portfolio Summary -->
    <section class="portfolio-hero animate-in delay-1">
        <div class="portfolio-label">Portfolio Value <span class="portfolio-label-jp">é‹ç”¨ç·é¡</span></div>
        <div class="portfolio-hero-inner">
            <div class="portfolio-value" id="portfolio-value">â€”</div>
            <div class="portfolio-return" id="portfolio-return">â€”</div>
        </div>
        <div class="portfolio-meta" id="portfolio-meta">Loading...</div>
    </section>

    <!-- Key Stats -->
    <div class="stats-row animate-in delay-2">
        <div class="stat-card">
            <div class="stat-label">YTD Return</div>
            <div class="stat-value" id="stat-ytd">â€”</div>
            <div class="stat-sub" id="stat-ytd-bench">â€”</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Sharpe Ratio</div>
            <div class="stat-value" id="stat-sharpe">â€”</div>
            <div class="stat-sub">Annualized</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Max Drawdown</div>
            <div class="stat-value" id="stat-drawdown">â€”</div>
            <div class="stat-sub" id="stat-drawdown-date">â€”</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Positions</div>
            <div class="stat-value" id="stat-positions">â€”</div>
            <div class="stat-sub" id="stat-positions-breakdown">â€”</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Cash</div>
            <div class="stat-value" id="stat-cash-pct">â€”</div>
            <div class="stat-sub" id="stat-cash-usd">â€”</div>
        </div>
    </div>

    <!-- Performance Chart -->
    <section class="chart-section animate-in delay-3">
        <div class="chart-header">
            <div class="chart-title">Cumulative Return <small>ç´¯ç©ãƒªã‚¿ãƒ¼ãƒ³</small></div>
            <div class="time-filters">
                <button class="time-btn" data-range="1m">1M</button>
                <button class="time-btn" data-range="3m">3M</button>
                <button class="time-btn" data-range="6m">6M</button>
                <button class="time-btn active" data-range="1y">1Y</button>
                <button class="time-btn" data-range="all">ALL</button>
            </div>
        </div>
        <div class="chart-container">
            <canvas id="performanceChart"></canvas>
        </div>
        <div class="chart-legend">
            <div class="legend-item"><div class="legend-dot" style="background: #2D5A3D;"></div>Portfolio</div>
            <div class="legend-item"><div class="legend-dot" style="background: #C4C4C4;"></div>Nikkei 225</div>
            <div class="legend-item"><div class="legend-dot" style="background: #D4C4A8;"></div>S&P 500</div>
        </div>
    </section>

    <hr class="divider">

    <!-- Holdings Table -->
    <section class="holdings-section animate-in delay-4">
        <div class="holdings-header">
            <div class="holdings-title">Current Holdings <small>ä¿æœ‰éŠ˜æŸ„</small></div>
            <div class="holdings-controls">
                <div class="filter-group" id="geo-filters">
                    <button class="filter-btn active" data-geo="all">All</button>
                    <button class="filter-btn" data-geo="JP">Japan</button>
                    <button class="filter-btn" data-geo="US">US</button>
                </div>
                <div class="holdings-count" id="holdings-count">â€”</div>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th class="sortable" data-sort="ticker">Ticker <span class="sort-arrow"></span></th>
                    <th class="sortable" data-sort="sector">Sector <span class="sort-arrow"></span></th>
                    <th class="sortable" data-sort="weight">Weight <span class="sort-arrow"></span></th>
                    <th>Avg Cost</th>
                    <th>Current</th>
                    <th class="sortable sorted-desc" data-sort="return_pct">Return <span class="sort-arrow">â†“</span></th>
                </tr>
            </thead>
            <tbody id="holdings-body">
                <tr><td colspan="6" style="text-align:center; color:var(--text-tertiary); padding:2rem;">Loading portfolio data...</td></tr>
            </tbody>
        </table>
    </section>

    <hr class="divider">

    <!-- Allocation Breakdown -->
    <section class="allocation-grid">
        <div class="allocation-card">
            <div class="allocation-card-title">Geography <span class="jp" style="font-size:0.6rem; font-weight:300; color:var(--text-tertiary);">åœ°åŸŸé…åˆ†</span></div>
            <div id="geo-allocation">Loading...</div>
        </div>
        <div class="allocation-card">
            <div class="allocation-card-title">Sector <span class="jp" style="font-size:0.6rem; font-weight:300; color:var(--text-tertiary);">ã‚»ã‚¯ã‚¿ãƒ¼é…åˆ†</span></div>
            <div id="sector-allocation">Loading...</div>
        </div>
    </section>

    <!-- Footer -->
    <footer>
        <div class="footer-left">Shadow portfolio for educational purposes only. Not investment advice.<br>Data refreshed daily via automated pipeline. Past performance does not indicate future results.</div>
        <div class="footer-right">è‡ªä¸»é‹ç”¨ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ª</div>
    </footer>

    <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Portfolio Frontend â€” Interactive
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let chartInstance = null;
    let portfolioData = null;
    let currentSort = { key: 'weight', direction: 'desc' };
    let currentGeoFilter = 'all';

    // â”€â”€ Utilities â”€â”€

    function formatCurrency(value) {
        return '$' + value.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function formatPct(value, showSign = true) {
        const sign = value >= 0 ? '+' : '';
        return (showSign ? sign : '') + value.toFixed(2) + '%';
    }

    function setReturnClass(element, value) {
        element.classList.remove('positive', 'negative', 'positive-cell', 'negative-cell');
        if (element.tagName === 'TD') {
            element.classList.add(value >= 0 ? 'positive-cell' : 'negative-cell');
        } else {
            element.classList.add(value >= 0 ? 'positive' : 'negative');
        }
    }

    // â”€â”€ Summary â”€â”€

    function renderSummary(data) {
        const s = data.summary;
        document.getElementById('portfolio-value').textContent = formatCurrency(s.portfolio_value);

        const returnEl = document.getElementById('portfolio-return');
        returnEl.textContent = formatPct(s.total_return) + ' since inception';
        setReturnClass(returnEl, s.total_return);

        document.getElementById('portfolio-meta').textContent =
            `Inception: ${data.inception_date} Â· Last updated: ${data.last_updated} Â· Starting capital: ${formatCurrency(data.starting_capital)}`;
    }

    // â”€â”€ Stats â”€â”€

    function renderStats(data) {
        const s = data.summary;

        const ytdEl = document.getElementById('stat-ytd');
        ytdEl.textContent = formatPct(s.ytd_return);
        setReturnClass(ytdEl, s.ytd_return);

        const nikkeiReturn = data.benchmarks['Nikkei 225'] ? data.benchmarks['Nikkei 225'].current : null;
        document.getElementById('stat-ytd-bench').textContent =
            nikkeiReturn !== null ? `vs. Nikkei 225 ${formatPct(nikkeiReturn)}` : '';

        document.getElementById('stat-sharpe').textContent = s.sharpe_ratio.toFixed(2);

        const ddEl = document.getElementById('stat-drawdown');
        ddEl.textContent = formatPct(s.max_drawdown, false);
        setReturnClass(ddEl, s.max_drawdown);
        document.getElementById('stat-drawdown-date').textContent = s.max_drawdown_date;

        document.getElementById('stat-positions').textContent = s.positions_count;
        document.getElementById('stat-positions-breakdown').textContent = `${s.jp_count} JP Â· ${s.us_count} US`;

        document.getElementById('stat-cash-pct').textContent = s.cash_pct.toFixed(1) + '%';
        document.getElementById('stat-cash-usd').textContent = formatCurrency(s.cash_usd);
    }

    // â”€â”€ Holdings Table (sortable, filterable, expandable) â”€â”€

    function getFilteredAndSortedHoldings(data) {
        let holdings = [...data.holdings];

        // Filter by geography
        if (currentGeoFilter === 'JP') {
            holdings = holdings.filter(h => h.currency === 'JPY');
        } else if (currentGeoFilter === 'US') {
            holdings = holdings.filter(h => h.currency === 'USD');
        }

        // Sort
        const key = currentSort.key;
        const dir = currentSort.direction === 'asc' ? 1 : -1;

        holdings.sort((a, b) => {
            let valA = a[key];
            let valB = b[key];

            if (typeof valA === 'string') {
                return dir * valA.localeCompare(valB);
            }
            return dir * (valA - valB);
        });

        return holdings;
    }

    function renderHoldings(data) {
        const tbody = document.getElementById('holdings-body');
        const holdings = getFilteredAndSortedHoldings(data);

        document.getElementById('holdings-count').textContent = `${holdings.length} positions`;

        if (holdings.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:var(--text-tertiary); padding:2rem;">No positions match filter</td></tr>';
            return;
        }

        tbody.innerHTML = holdings.map(h => `
            <tr class="holding-row" data-ticker="${h.ticker}">
                <td>
                    <div class="ticker">${h.ticker}</div>
                    <div class="company-name">${h.company_name}</div>
                </td>
                <td><span class="tag">${h.sector}</span></td>
                <td>${h.weight.toFixed(1)}%</td>
                <td>${h.display_cost}</td>
                <td>${h.display_current}</td>
                <td class="${h.return_pct >= 0 ? 'positive-cell' : 'negative-cell'}">${formatPct(h.return_pct)}</td>
            </tr>
            <tr class="holding-detail" id="detail-${h.ticker.replace('.', '-')}">
                <td colspan="6">
                    <div class="detail-inner">
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Shares Held</div>
                                <div class="detail-value">${h.shares.toLocaleString()}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Market Value (USD)</div>
                                <div class="detail-value">${formatCurrency(h.value_usd)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Cost Basis (USD)</div>
                                <div class="detail-value">${formatCurrency(h.cost_usd)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">P&L (USD)</div>
                                <div class="detail-value ${h.return_pct >= 0 ? 'positive-cell' : 'negative-cell'}">${formatCurrency(h.value_usd - h.cost_usd)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Geography</div>
                                <div class="detail-value">${h.currency === 'JPY' ? 'ğŸ‡¯ğŸ‡µ Japan' : 'ğŸ‡ºğŸ‡¸ United States'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Currency</div>
                                <div class="detail-value">${h.currency}</div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        `).join('');

        // Attach click handlers to expandable rows
        document.querySelectorAll('.holding-row').forEach(row => {
            row.addEventListener('click', () => {
                const ticker = row.dataset.ticker.replace('.', '-');
                const detail = document.getElementById('detail-' + ticker);
                const isOpen = detail.classList.contains('open');

                // Close all others
                document.querySelectorAll('.holding-detail.open').forEach(d => d.classList.remove('open'));
                document.querySelectorAll('.holding-row.expanded').forEach(r => r.classList.remove('expanded'));

                if (!isOpen) {
                    detail.classList.add('open');
                    row.classList.add('expanded');
                }
            });
        });
    }

    // â”€â”€ Sorting â”€â”€

    function initSorting() {
        document.querySelectorAll('th.sortable').forEach(th => {
            th.addEventListener('click', () => {
                const key = th.dataset.sort;

                if (currentSort.key === key) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.key = key;
                    currentSort.direction = 'desc';
                }

                // Update header arrows
                document.querySelectorAll('th.sortable').forEach(header => {
                    header.classList.remove('sorted-asc', 'sorted-desc');
                    header.querySelector('.sort-arrow').textContent = '';
                });
                th.classList.add(currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc');
                th.querySelector('.sort-arrow').textContent = currentSort.direction === 'asc' ? 'â†‘' : 'â†“';

                if (portfolioData) renderHoldings(portfolioData);
            });
        });
    }

    // â”€â”€ Geography Filters â”€â”€

    function initGeoFilters() {
        document.querySelectorAll('.filter-btn[data-geo]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn[data-geo]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentGeoFilter = btn.dataset.geo;
                if (portfolioData) renderHoldings(portfolioData);
            });
        });
    }

    // â”€â”€ Allocations â”€â”€

    function renderAllocations(data) {
        const alloc = data.allocations;
        document.getElementById('geo-allocation').innerHTML = renderBarGroups(alloc.geography);
        document.getElementById('sector-allocation').innerHTML = renderBarGroups(alloc.sector);
    }

    function renderBarGroups(items) {
        const entries = Object.entries(items);
        return entries.map(([label, value], i) => {
            const opacity = label === 'Cash'
                ? 'background:var(--text-tertiary); opacity:0.3'
                : `opacity:${Math.max(0.35, 1 - (i * 0.15))}`;

            return `
                <div class="alloc-bar-group">
                    <div class="alloc-bar-label">
                        <span>${label}</span>
                        <span>${value.toFixed(1)}%</span>
                    </div>
                    <div class="alloc-bar-track">
                        <div class="alloc-bar-fill" style="width:${value}%; ${opacity}"></div>
                    </div>
                </div>
            `;
        }).join('');
    }

    // â”€â”€ Chart â”€â”€

    function renderChart(data, range = 'all') {
        const chart = data.chart;
        const dates = chart.dates;
        const portfolio = chart.portfolio;
        const nikkei = chart['Nikkei 225'] || [];
        const sp500 = chart['S&P 500'] || [];

        // Filter by range
        let startIdx = 0;
        if (range !== 'all' && dates.length > 0) {
            const endDate = new Date(dates[dates.length - 1]);
            let cutoff = new Date(endDate);
            switch (range) {
                case '1m': cutoff.setMonth(cutoff.getMonth() - 1); break;
                case '3m': cutoff.setMonth(cutoff.getMonth() - 3); break;
                case '6m': cutoff.setMonth(cutoff.getMonth() - 6); break;
                case '1y': cutoff.setFullYear(cutoff.getFullYear() - 1); break;
            }
            startIdx = dates.findIndex(d => new Date(d) >= cutoff);
            if (startIdx < 0) startIdx = 0;
        }

        const slicedDates = dates.slice(startIdx);
        const slicedPortfolio = portfolio.slice(startIdx);
        const slicedNikkei = nikkei.slice(startIdx);
        const slicedSP = sp500.slice(startIdx);

        // Rebase to start at 0 for the selected range
        const baseP = slicedPortfolio[0] || 0;
        const baseN = slicedNikkei[0] || 0;
        const baseS = slicedSP[0] || 0;

        const rebasedPortfolio = slicedPortfolio.map(v => +(v - baseP).toFixed(2));
        const rebasedNikkei = slicedNikkei.map(v => +(v - baseN).toFixed(2));
        const rebasedSP = slicedSP.map(v => +(v - baseS).toFixed(2));

        const labels = slicedDates.map(d => {
            const date = new Date(d);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        });

        // Thin out labels for readability
        const step = Math.max(1, Math.floor(labels.length / 10));
        const cleanLabels = labels.map((l, i) => i % step === 0 ? l : '');

        if (chartInstance) chartInstance.destroy();

        const ctx = document.getElementById('performanceChart').getContext('2d');
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: cleanLabels,
                datasets: [
                    {
                        label: 'Portfolio',
                        data: rebasedPortfolio,
                        borderColor: '#2D5A3D',
                        backgroundColor: 'rgba(45,90,61,0.04)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        pointHoverBackgroundColor: '#2D5A3D',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2,
                    },
                    {
                        label: 'Nikkei 225',
                        data: rebasedNikkei,
                        borderColor: '#C4C4C4',
                        borderWidth: 1.5,
                        borderDash: [4, 3],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                    },
                    {
                        label: 'S&P 500',
                        data: rebasedSP,
                        borderColor: '#D4C4A8',
                        borderWidth: 1.5,
                        borderDash: [4, 3],
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 3,
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1A1A1A',
                        titleFont: { family: 'DM Sans', size: 11, weight: '400' },
                        bodyFont: { family: 'DM Sans', size: 11 },
                        padding: 12,
                        cornerRadius: 3,
                        displayColors: true,
                        boxWidth: 8,
                        boxHeight: 2,
                        callbacks: {
                            title: function(items) {
                                const idx = items[0].dataIndex;
                                return slicedDates[idx] ? new Date(slicedDates[idx]).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }) : '';
                            },
                            label: function(context) {
                                const val = context.parsed.y;
                                const sign = val >= 0 ? '+' : '';
                                return ' ' + context.dataset.label + ': ' + sign + val.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { family: 'DM Sans', size: 10, weight: '400' },
                            color: '#9B9B9B',
                            padding: 8,
                            maxRotation: 0,
                        },
                        border: { display: false },
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                        ticks: {
                            font: { family: 'DM Sans', size: 10, weight: '400' },
                            color: '#9B9B9B',
                            padding: 12,
                            callback: function(value) { return (value >= 0 ? '+' : '') + value + '%'; }
                        },
                        border: { display: false },
                    }
                }
            }
        });
    }

    // â”€â”€ Time Filters â”€â”€

    function initTimeFilters() {
        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                if (portfolioData) renderChart(portfolioData, btn.dataset.range);
            });
        });
    }

    // â”€â”€ Initialize â”€â”€

    async function init() {
        initTimeFilters();
        initSorting();
        initGeoFilters();

        try {
            const response = await fetch('data/portfolio.json');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);

            portfolioData = await response.json();

            renderSummary(portfolioData);
            renderStats(portfolioData);
            renderHoldings(portfolioData);
            renderAllocations(portfolioData);
            renderChart(portfolioData, '1y');

        } catch (error) {
            console.error('Failed to load portfolio data:', error);
            document.getElementById('portfolio-value').textContent = 'â€”';
            document.getElementById('portfolio-meta').textContent =
                'Portfolio data unavailable. Run the pipeline to generate data/portfolio.json';
        }
    }

    init();
    </script>

</body>
</html>
