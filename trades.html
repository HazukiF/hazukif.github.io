<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hazuki — Trade History</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,400&family=DM+Sans:wght@300;400;500&family=Noto+Sans+JP:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/main.js"></script>
</head>
<body>

    <header class="animate-in">
        <a href="index.html" class="site-title">Hazuki <span class="jp">シャドウ・ポートフォリオ</span></a>
        <div class="header-right">
            <nav>
                <a href="index.html" data-i18n="nav-portfolio">Portfolio</a>
                <a href="philosophy.html" data-i18n="nav-philosophy">Philosophy</a>
                <a href="trades.html" class="active" data-i18n="nav-trades">Trades</a>
                <a href="research.html" data-i18n="nav-research">Research</a>
                <a href="about.html" data-i18n="nav-about">About</a>
            </nav>
            <div class="site-controls">
                <button class="control-btn" id="lang-toggle-btn" title="Toggle language">JP</button>
                <button class="control-btn" id="dark-mode-btn" title="Toggle dark mode">☾</button>
            </div>
        </div>
    </header>

    <hr class="divider">

    <section class="about-page">
        <h1 class="about-page-title animate-in" data-i18n="trades-title">Trade History</h1>
        <p class="about-page-subtitle animate-in delay-1">取引履歴</p>

        <div class="trades-controls animate-in delay-2">
            <div class="filter-group" id="action-filters">
                <button class="filter-btn active" data-action="all" data-i18n="filter-all">All</button>
                <button class="filter-btn" data-action="BUY" data-i18n="filter-buys">Buys</button>
                <button class="filter-btn" data-action="SELL" data-i18n="filter-sells">Sells</button>
            </div>
            <div class="filter-group" id="currency-filters">
                <button class="filter-btn active" data-currency="all" data-i18n="filter-all">All</button>
                <button class="filter-btn" data-currency="JPY" data-i18n="filter-japan">Japan</button>
                <button class="filter-btn" data-currency="USD" data-i18n="filter-us">US</button>
            </div>
            <div class="trades-summary" id="trades-summary">Loading...</div>
        </div>

        <table class="animate-in delay-3">
            <thead>
                <tr>
                    <th class="sortable sorted-desc" data-sort="date"><span data-i18n="th-date">Date</span> <span class="sort-arrow">↓</span></th>
                    <th><span data-i18n="th-action">Action</span></th>
                    <th class="sortable" data-sort="ticker"><span data-i18n="th-ticker">Ticker</span> <span class="sort-arrow"></span></th>
                    <th><span data-i18n="th-shares">Shares</span></th>
                    <th><span data-i18n="th-price">Price</span></th>
                    <th><span data-i18n="th-value">Value</span></th>
                    <th><span data-i18n="th-notes">Notes</span></th>
                </tr>
            </thead>
            <tbody id="trades-body">
                <tr><td colspan="7" style="text-align:center; color:var(--text-tertiary); padding:2rem;">Loading...</td></tr>
            </tbody>
        </table>
    </section>

    <footer>
        <div class="footer-left" data-i18n="footer-disclaimer">Shadow portfolio for educational purposes only. Not investment advice.</div>
        <div class="footer-right">自主運用ポートフォリオ</div>
    </footer>

    <script>
    let tradesData = [];
    let currentActionFilter = 'all';
    let currentCurrencyFilter = 'all';
    let currentSort = { key: 'date', direction: 'desc' };

    async function loadTrades() {
        try {
            const response = await fetch('data/trades.csv');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const text = await response.text();
            const lines = text.trim().split('\n');
            tradesData = lines.slice(1).map(line => {
                const parts = []; let current = ''; let inQ = false;
                for (const c of line) { if (c==='"'){inQ=!inQ;continue;} if (c===','&&!inQ){parts.push(current);current='';continue;} current+=c; }
                parts.push(current);
                return { date:parts[0], ticker:parts[1], action:parts[2], shares:parseFloat(parts[3]), price:parseFloat(parts[4]), currency:parts[5], notes:parts[6]||'' };
            });
            renderTrades();
        } catch (e) {
            document.getElementById('trades-body').innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-tertiary); padding:2rem;">Trade data unavailable</td></tr>';
        }
    }

    function getFilteredAndSorted() {
        let trades = [...tradesData];
        if (currentActionFilter !== 'all') trades = trades.filter(t => t.action === currentActionFilter);
        if (currentCurrencyFilter !== 'all') trades = trades.filter(t => t.currency === currentCurrencyFilter);
        const dir = currentSort.direction === 'asc' ? 1 : -1;
        trades.sort((a,b) => { const vA=a[currentSort.key],vB=b[currentSort.key]; return typeof vA==='string' ? dir*vA.localeCompare(vB) : dir*(vA-vB); });
        return trades;
    }

    function renderTrades() {
        const trades = getFilteredAndSorted();
        const tbody = document.getElementById('trades-body');
        const buys = trades.filter(t=>t.action==='BUY').length, sells = trades.filter(t=>t.action==='SELL').length;
        document.getElementById('trades-summary').textContent = `${trades.length} trades · ${buys} buys · ${sells} sells`;
        if (trades.length === 0) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-tertiary); padding:2rem;">No trades match filter</td></tr>'; return; }
        tbody.innerHTML = trades.map(t => {
            const sym = t.currency==='JPY'?'¥':'$';
            const total = t.shares * t.price;
            const fp = t.currency==='JPY' ? `¥${t.price.toLocaleString('en-US',{minimumFractionDigits:0})}` : `$${t.price.toLocaleString('en-US',{minimumFractionDigits:2})}`;
            const fv = t.currency==='JPY' ? `¥${total.toLocaleString('en-US',{minimumFractionDigits:0})}` : `$${total.toLocaleString('en-US',{minimumFractionDigits:2})}`;
            const df = new Date(t.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
            return `<tr><td>${df}</td><td><span class="action-tag ${t.action.toLowerCase()}-tag">${t.action}</span></td><td><span class="ticker">${t.ticker}</span></td><td>${t.shares.toLocaleString()}</td><td>${fp}</td><td>${fv}</td><td class="trade-notes">${t.notes}</td></tr>`;
        }).join('');
    }

    document.querySelectorAll('#action-filters .filter-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('#action-filters .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); currentActionFilter=btn.dataset.action; renderTrades(); }); });
    document.querySelectorAll('#currency-filters .filter-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('#currency-filters .filter-btn').forEach(b=>b.classList.remove('active')); btn.classList.add('active'); currentCurrencyFilter=btn.dataset.currency; renderTrades(); }); });
    document.querySelectorAll('th.sortable').forEach(th => { th.addEventListener('click', () => {
        const key=th.dataset.sort; if(currentSort.key===key) currentSort.direction=currentSort.direction==='asc'?'desc':'asc'; else {currentSort.key=key;currentSort.direction='desc';}
        document.querySelectorAll('th.sortable').forEach(h=>{h.classList.remove('sorted-asc','sorted-desc');h.querySelector('.sort-arrow').textContent='';});
        th.classList.add(currentSort.direction==='asc'?'sorted-asc':'sorted-desc'); th.querySelector('.sort-arrow').textContent=currentSort.direction==='asc'?'↑':'↓'; renderTrades();
    }); });

    loadTrades();
    </script>
</body>
</html>
